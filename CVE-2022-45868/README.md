# H2 Database密码暴露（CVE-2022-45868）

## Affected versions

```
<= 2.1.214
```

这个漏洞属于一个设计上的缺陷，是因为开发人员缺乏安全常识导致的，h2这个包是可以通过main方法运行的，并且main方法的参数允许通过命令行启动程序的时候通过参数`-webAdminPassword`传递密码，但是实际上这里输入的密码可能会被泄露，其中一种方式就是`.history`文件，这种需要拥有`.history`的读权限，不过这种还好，另一种情况是像这种需要长时间启动在后台运行着的程序，它的启动命令参数可以通过查看进程来看到， 比如`ps`就会泄露，这种情况下就是一个蛮严重的问题了，更要命的是在Linux下用户通过ps能够看到其它用户的进程及相关启动参数，这就要了命了，不过开发者认为一个合格的`DBA`不会干出这种事，所以开发者认为这不是漏洞。

下载Jar包：

```
wget https://repo1.maven.org/maven2/com/h2database/h2/2.1.214/h2-2.1.214.jar
```

进入数据库shell：

```bash
java -cp h2-2.1.214.jar org.h2.tools.Shell
```

查看服务选项：

```bash
cc11001100@ubuntu-server:/opt/java$ java -cp h2-2.1.214.jar org.h2.tools.Server -help 
Starts the H2 Console (web-) server, TCP, and PG server.
Usage: java org.h2.tools.Server <options>
When running without options, -tcp, -web, -browser and -pg are started.

 Options are case sensitive.
Supported options[-help] or [-?]Print the list of options
[-web]                  Start the web server with the H2 Console
[-webAllowOthers]       Allow other computers to connect - see below
[-webDaemon]            Use a daemon thread
[-webPort <port>]       The port (default: 8082)
[-webSSL]               Use encrypted (HTTPS) connections
[-webAdminPassword]     Password of DB Console administrator
[-browser]              Start a browser connecting to the web server
[-tcp]                  Start the TCP server
[-tcpAllowOthers]       Allow other computers to connect - see below
[-tcpDaemon]            Use a daemon thread
[-tcpPort <port>]       The port (default: 9092)
[-tcpSSL]               Use encrypted (SSL) connections
[-tcpPassword <pwd>]    The password for shutting down a TCP server
[-tcpShutdown "<url>"]  Stop the TCP server; example: tcp://localhost
[-tcpShutdownForce]     Do not wait until all connections are closed
[-pg]                   Start the PG server
[-pgAllowOthers]        Allow other computers to connect - see below
[-pgDaemon]             Use a daemon thread
[-pgPort <port>]        The port (default: 5435)
[-properties "<dir>"]   Server properties (default: ~, disable: null)
[-baseDir <dir>]        The base directory for H2 databases (all servers)
[-ifExists]             Only existing databases may be opened (all servers)
[-ifNotExists]          Databases are created when accessed
[-trace]                Print additional trace information (all servers)
[-key <from> <to>]      Allows to map a database name to another (all servers)
The options -xAllowOthers are potentially risky.

 For details, see Advanced Topics / Protection against Remote Access.
See also https://h2database.com/javadoc/org/h2/tools/Server.html
```

可以看到有个设置密码的选项：

```text
[-webAdminPassword]     Password of DB Console administrator
```

启动web server：

```bash
java -cp h2-2.1.214.jar org.h2.tools.Server -webAdminPassword weakpasswd -webPort 10086 -webDaemon -webAllowOthers
```

开启一个新的tab页，执行命令ps筛选h2进程，可以看到启动密码清晰可见：

```bash
root@ubuntu-server:/opt/java# ps -ef | grep h2 
cc11001+    4178    3332  1 13:55 pts/2    00:00:00 java -cp h2-2.1.214.jar org.h2.tools.Server -webAdminPassword weakpasswd -webPort 10086 -webDaemon -webAllowOthers
root        4317    1839  0 13:56 pts/1    00:00:00 grep --color=auto h2
```

即使是切换到其它用户也能看到密码：

```bash
cc11001100@ubuntu-server:~$ ps -ef | grep h2 
cc11001+    4178    3332  0 13:55 pts/2    00:00:00 java -cp h2-2.1.214.jar org.h2.tools.Server -webAdminPassword weakpasswd -webPort 10086 -webDaemon -webAllowOthers
cc11001+    4586    4319  0 13:56 pts/1    00:00:00 grep --color=auto h2
```

所以要切记不要在启动命令上使用参数传递敏感信息。

## 参考资料

- https://github.com/advisories/GHSA-22wj-vf5f-wrvj
- 